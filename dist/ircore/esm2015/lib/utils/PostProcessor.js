import { EmoteList } from './EmoteList';
import { ValidRegex } from './validRegex';
export class PostProcessor {
    static processMessage(message, author, me) {
        const mwm = new MessageWithMetadata();
        const youtubeLink = /((?:https?:)?\/\/)?((?:www|m)\.)?((?:youtube\.com|youtu.be))(\/(?:[\w\-]+\?v=|embed\/|v\/)?)([\w\-]+)(\S+)?/.exec(message);
        if (youtubeLink) {
            message = message.replace(youtubeLink[0], '');
            mwm.youtube = youtubeLink[5];
        }
        const imageLink = /(http(s?):)([\/|.|\w|\s|-])*\.(?:jpg|gif|png)/.exec(message);
        if (imageLink) {
            message = message.replace(imageLink[0], '');
            mwm.image = imageLink[0];
        }
        const otherLink = /(http|https):\/\/([\w_-]+(?:(?:\.[\w_-]+)+))([\w.,@?^=%&:\/~+#-]*[\w@?^=%&\/~+#-])?/.exec(message);
        if (otherLink) {
            message = message.replace(otherLink[0], '');
            mwm.link = otherLink[0];
        }
        const quote = /^<([^>]+)>\s([^|]+)\|?(.*)$/.exec(message);
        if (quote) {
            mwm.quote = {
                author: quote[1],
                originalMessage: quote[2]
            };
            message = quote[3];
        }
        // prevent XSS:
        const temp = document.createElement('div');
        temp.textContent = message;
        message = temp.innerHTML;
        // end of xss prevention
        // replacing memes
        const faces = message.match(/:([a-zA-Z0-9]+):/g);
        if (faces) {
            faces.forEach(face => {
                const realName = face.replace(':', '').replace(':', '');
                const realLocation = EmoteList.getFace(realName, author);
                if (realLocation) {
                    message = message.replace(face, '<img src="' + realLocation + '" class="faceEmote ' + realName + '" data-name="' +
                        realName + '" title=":' + realName + '" alt=":' + realName + '"/>');
                }
            });
        }
        const memes = message.match(/;([a-zA-Z0-9]+);/g);
        if (memes) {
            memes.forEach(meme => {
                const realName = meme.replace(';', '').replace(';', '');
                const realLocation = EmoteList.getMeme(realName, author);
                if (realLocation) {
                    message = message.replace(meme, '<img src="' + realLocation + '" class="memeEmote ' + realName + '" data-name="' + realName +
                        '" title=";' + realName + '" alt=";' + realName + '"/>');
                }
            });
        }
        mwm.message = PostProcessor.processPings(message, me);
        return mwm;
    }
    static processPings(mwm, me) {
        const regex = ValidRegex.getRegex(ValidRegex.pingRegex(me));
        const result = regex.exec(mwm);
        if (result) {
            mwm = '';
            if (result[1]) {
                mwm += result[1];
            }
            if (result[2]) {
                mwm += result[2];
            }
            mwm += '<b class="ping">' + result[3] + '</b>';
            if (result[4]) {
                mwm += result[4];
            }
            if (result[5]) {
                mwm += result[5];
            }
            mwm = mwm.replace(', ,', ',');
        }
        return mwm;
    }
    static deconverHTML(msg) {
        const matchs = msg.match(/\<img\ssrc\=\"([^"]+)\"\sclass\=\"([^"]+)\"\sdata-name="([^"]+)"\stitle="([^"]+)"\salt="([^"]+)"\/\>/g);
        if (matchs) {
            matchs.forEach(match => {
                const data = /\<img\ssrc\=\"([^"]+)\"\sclass\=\"([^"]+)\"\sdata-name="([^"]+)"\stitle="([^"]+)"\salt="([^"]+)"\/\>/.exec(match);
                msg = msg.replace(data[0], data[4]);
            });
        }
        return msg;
    }
    static processUserMetadata(user) {
        const mod = user[0];
        if (mod === '~' ||
            mod === '&' ||
            mod === '@' ||
            mod === '%' ||
            mod === '+') {
            user = user.slice(1);
        }
        const out = new UserWithMetadata();
        out.nick = user;
        if (mod === '~') {
            out.status = UserStatuses.FOUNDER;
        }
        else if (mod === '&') {
            out.status = UserStatuses.NET_OPERATOR;
        }
        else if (mod === '@') {
            out.status = UserStatuses.OPERATOR;
        }
        else if (mod === '%') {
            out.status = UserStatuses.HALF_OPERATOR;
        }
        else if (mod === '+') {
            out.status = UserStatuses.VOICE;
        }
        return out;
    }
}
export class UserWithMetadata {
}
export class MessageWithMetadata {
}
export class QuoteMessage {
}
export var UserStatuses;
(function (UserStatuses) {
    UserStatuses["FOUNDER"] = "FOUNDER";
    UserStatuses["NET_OPERATOR"] = "NET_OPERATOR";
    UserStatuses["OPERATOR"] = "OPERATOR";
    UserStatuses["HALF_OPERATOR"] = "HALF_OPERATOR";
    UserStatuses["VOICE"] = "VOICE";
    UserStatuses["BANNED"] = "BANNED";
})(UserStatuses || (UserStatuses = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUG9zdFByb2Nlc3Nvci5qcyIsInNvdXJjZVJvb3QiOiJDOi9Vc2Vycy9hbGV4YS9naXQvSVJDb3JlL3Byb2plY3RzL2lyY29yZS9zcmMvIiwic291cmNlcyI6WyJsaWIvdXRpbHMvUG9zdFByb2Nlc3Nvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFMUMsTUFBTSxPQUFPLGFBQWE7SUFFakIsTUFBTSxDQUFDLGNBQWMsQ0FBQyxPQUFlLEVBQUUsTUFBYyxFQUFFLEVBQVU7UUFDdEUsTUFBTSxHQUFHLEdBQUcsSUFBSSxtQkFBbUIsRUFBRSxDQUFDO1FBRXRDLE1BQU0sV0FBVyxHQUFHLDZHQUE2RyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNoSixJQUFJLFdBQVcsRUFBRTtZQUNmLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUM5QyxHQUFHLENBQUMsT0FBTyxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUM5QjtRQUNELE1BQU0sU0FBUyxHQUFHLCtDQUErQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNoRixJQUFJLFNBQVMsRUFBRTtZQUNiLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUM1QyxHQUFHLENBQUMsS0FBSyxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUMxQjtRQUNELE1BQU0sU0FBUyxHQUFHLHFGQUFxRixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN0SCxJQUFJLFNBQVMsRUFBRTtZQUNiLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMs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QixxQ0FBcUIsQ0FBQTtJQUNyQiwrQ0FBK0IsQ0FBQTtJQUMvQiwrQkFBZSxDQUFBO0lBQ2YsaUNBQWlCLENBQUE7QUFDbkIsQ0FBQyxFQVBXLFlBQVksS0FBWixZQUFZLFFBT3ZCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRW1vdGVMaXN0IH0gZnJvbSAnLi9FbW90ZUxpc3QnO1xuaW1wb3J0IHsgVmFsaWRSZWdleCB9IGZyb20gJy4vdmFsaWRSZWdleCc7XG5cbmV4cG9ydCBjbGFzcyBQb3N0UHJvY2Vzc29yIHtcblxuICBwdWJsaWMgc3RhdGljIHByb2Nlc3NNZXNzYWdlKG1lc3NhZ2U6IHN0cmluZywgYXV0aG9yOiBzdHJpbmcsIG1lOiBzdHJpbmcpOiBNZXNzYWdlV2l0aE1ldGFkYXRhIHtcbiAgICBjb25zdCBtd20gPSBuZXcgTWVzc2FnZVdpdGhNZXRhZGF0YSgpO1xuXG4gICAgY29uc3QgeW91dHViZUxpbmsgPSAvKCg/Omh0dHBzPzopP1xcL1xcLyk/KCg/Ond3d3xtKVxcLik/KCg/OnlvdXR1YmVcXC5jb218eW91dHUuYmUpKShcXC8oPzpbXFx3XFwtXStcXD92PXxlbWJlZFxcL3x2XFwvKT8pKFtcXHdcXC1dKykoXFxTKyk/Ly5leGVjKG1lc3NhZ2UpO1xuICAgIGlmICh5b3V0dWJlTGluaykge1xuICAgICAgbWVzc2FnZSA9IG1lc3NhZ2UucmVwbGFjZSh5b3V0dWJlTGlua1swXSwgJycpO1xuICAgICAgbXdtLnlvdXR1YmUgPSB5b3V0dWJlTGlua1s1XTtcbiAgICB9XG4gICAgY29uc3QgaW1hZ2VMaW5rID0gLyhodHRwKHM/KTopKFtcXC98LnxcXHd8XFxzfC1dKSpcXC4oPzpqcGd8Z2lmfHBuZykvLmV4ZWMobWVzc2FnZSk7XG4gICAgaWYgKGltYWdlTGluaykge1xuICAgICAgbWVzc2FnZSA9IG1lc3NhZ2UucmVwbGFjZShpbWFnZUxpbmtbMF0sICcnKTtcbiAgICAgIG13bS5pbWFnZSA9IGltYWdlTGlua1swXTtcbiAgICB9XG4gICAgY29uc3Qgb3RoZXJMaW5rID0gLyhodHRwfGh0dHBzKTpcXC9cXC8oW1xcd18tXSsoPzooPzpcXC5bXFx3Xy1dKykrKSkoW1xcdy4sQD9ePSUmOlxcL34rIy1dKltcXHdAP149JSZcXC9+KyMtXSk/Ly5leGVjKG1lc3NhZ2UpO1xuICAgIGlmIChvdGhlckxpbmspIHtcbiAgICAgIG1lc3NhZ2UgPSBtZXNzYWdlLnJlcGxhY2Uob3RoZXJMaW5rWzBdLCAnJyk7XG4gICAgICBtd20ubGluayA9IG90aGVyTGlua1swXTtcbiAgICB9XG4gICAgY29uc3QgcXVvdGUgPSAvXjwoW14+XSspPlxccyhbXnxdKylcXHw/KC4qKSQvLmV4ZWMobWVzc2FnZSk7XG4gICAgaWYgKHF1b3RlKSB7XG4gICAgICBtd20ucXVvdGUgPSB7XG4gICAgICAgIGF1dGhvcjogcXVvdGVbMV0sXG4gICAgICAgIG9yaWdpbmFsTWVzc2FnZTogcXVvdGVbMl1cbiAgICAgIH07XG4gICAgICBtZXNzYWdlID0gcXVvdGVbM107XG4gICAgfVxuXG4gICAgLy8gcHJldmVudCBYU1M6XG4gICAgY29uc3QgdGVtcCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgIHRlbXAudGV4dENvbnRlbnQgPSBtZXNzYWdlO1xuICAgIG1lc3NhZ2UgPSB0ZW1wLmlubmVySFRNTDtcbiAgICAvLyBlbmQgb2YgeHNzIHByZXZlbnRpb25cblxuICAgIC8vIHJlcGxhY2luZyBtZW1lc1xuICAgIGNvbnN0IGZhY2VzID0gbWVzc2FnZS5tYXRjaCgvOihbYS16QS1aMC05XSspOi9nKTtcbiAgICBpZiAoZmFjZXMpIHtcbiAgICAgIGZhY2VzLmZvckVhY2goZmFjZSA9PiB7XG4gICAgICAgIGNvbnN0IHJlYWxOYW1lID0gZmFjZS5yZXBsYWNlKCc6JywgJycpLnJlcGxhY2UoJzonLCAnJyk7XG4gICAgICAgIGNvbnN0IHJlYWxMb2NhdGlvbiA9IEVtb3RlTGlzdC5nZXRGYWNlKHJlYWxOYW1lLCBhdXRob3IpO1xuICAgICAgICBpZiAocmVhbExvY2F0aW9uKSB7XG4gICAgICAgICAgbWVzc2FnZSA9IG1lc3NhZ2UucmVwbGFjZShmYWNlLCAnPGltZyBzcmM9XCInICsgcmVhbExvY2F0aW9uICsgJ1wiIGNsYXNzPVwiZmFjZUVtb3RlICcgKyByZWFsTmFtZSArICdcIiBkYXRhLW5hbWU9XCInICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxOYW1lICsgJ1wiIHRpdGxlPVwiOicgKyByZWFsTmFtZSArICdcIiBhbHQ9XCI6JyArIHJlYWxOYW1lICsgJ1wiLz4nKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgbWVtZXMgPSBtZXNzYWdlLm1hdGNoKC87KFthLXpBLVowLTldKyk7L2cpO1xuICAgIGlmIChtZW1lcykge1xuICAgICAgbWVtZXMuZm9yRWFjaChtZW1lID0+IHtcbiAgICAgICAgY29uc3QgcmVhbE5hbWUgPSBtZW1lLnJlcGxhY2UoJzsnLCAnJykucmVwbGFjZSgnOycsICcnKTtcbiAgICAgICAgY29uc3QgcmVhbExvY2F0aW9uID0gRW1vdGVMaXN0LmdldE1lbWUocmVhbE5hbWUsIGF1dGhvcik7XG4gICAgICAgIGlmIChyZWFsTG9jYXRpb24pIHtcbiAgICAgICAgICBtZXNzYWdlID0gbWVzc2FnZS5yZXBsYWNlKG1lbWUsICc8aW1nIHNyYz1cIicgKyByZWFsTG9jYXRpb24gKyAnXCIgY2xhc3M9XCJtZW1lRW1vdGUgJyArIHJlYWxOYW1lICsgJ1wiIGRhdGEtbmFtZT1cIicgKyByZWFsTmFtZSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnXCIgdGl0bGU9XCI7JyArIHJlYWxOYW1lICsgJ1wiIGFsdD1cIjsnICsgcmVhbE5hbWUgKyAnXCIvPicpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBtd20ubWVzc2FnZSA9IFBvc3RQcm9jZXNzb3IucHJvY2Vzc1BpbmdzKG1lc3NhZ2UsIG1lKTtcbiAgICByZXR1cm4gbXdtO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBwcm9jZXNzUGluZ3MobXdtOiBzdHJpbmcsIG1lOiBzdHJpbmcpIHtcbiAgICBjb25zdCByZWdleCA9IFZhbGlkUmVnZXguZ2V0UmVnZXgoVmFsaWRSZWdleC5waW5nUmVnZXgobWUpKTtcbiAgICBjb25zdCByZXN1bHQgPSByZWdleC5leGVjKG13bSk7XG4gICAgaWYocmVzdWx0KSB7XG4gICAgICBtd20gPSAnJztcbiAgICAgIGlmKHJlc3VsdFsxXSkge1xuICAgICAgICBtd20gKz0gcmVzdWx0WzFdO1xuICAgICAgfVxuICAgICAgaWYocmVzdWx0WzJdKSB7XG4gICAgICAgIG13bSArPSByZXN1bHRbMl07XG4gICAgICB9XG4gICAgICBtd20gKz0gJzxiIGNsYXNzPVwicGluZ1wiPicgKyByZXN1bHRbM10gKyAnPC9iPic7XG4gICAgICBpZihyZXN1bHRbNF0pIHtcbiAgICAgICAgbXdtICs9IHJlc3VsdFs0XTtcbiAgICAgIH1cbiAgICAgIGlmKHJlc3VsdFs1XSkge1xuICAgICAgICBtd20gKz0gcmVzdWx0WzVdO1xuICAgICAgfVxuICAgICAgbXdtID0gbXdtLnJlcGxhY2UoJywgLCcsICcsJyk7XG4gICAgfVxuICAgIHJldHVybiBtd207XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGRlY29udmVySFRNTChtc2c6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgbWF0Y2hzID0gbXNnLm1hdGNoKC9cXDxpbWdcXHNzcmNcXD1cXFwiKFteXCJdKylcXFwiXFxzY2xhc3NcXD1cXFwiKFteXCJdKylcXFwiXFxzZGF0YS1uYW1lPVwiKFteXCJdKylcIlxcc3RpdGxlPVwiKFteXCJdKylcIlxcc2FsdD1cIihbXlwiXSspXCJcXC9cXD4vZyk7XG4gICAgaWYgKG1hdGNocykge1xuICAgICAgbWF0Y2hzLmZvckVhY2gobWF0Y2ggPT4ge1xuICAgICAgICBjb25zdCBkYXRhID0gL1xcPGltZ1xcc3NyY1xcPVxcXCIoW15cIl0rKVxcXCJcXHNjbGFzc1xcPVxcXCIoW15cIl0rKVxcXCJcXHNkYXRhLW5hbWU9XCIoW15cIl0rKVwiXFxzdGl0bGU9XCIoW15cIl0rKVwiXFxzYWx0PVwiKFteXCJdKylcIlxcL1xcPi8uZXhlYyhtYXRjaCk7XG4gICAgICAgIG1zZyA9IG1zZy5yZXBsYWNlKGRhdGFbMF0sIGRhdGFbNF0pO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBtc2c7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIHByb2Nlc3NVc2VyTWV0YWRhdGEodXNlcjogc3RyaW5nKTogVXNlcldpdGhNZXRhZGF0YSB7XG4gICAgY29uc3QgbW9kID0gdXNlclswXTtcbiAgICBpZiAobW9kID09PSAnficgfHxcbiAgICAgICAgbW9kID09PSAnJicgfHxcbiAgICAgICAgbW9kID09PSAnQCcgfHxcbiAgICAgICAgbW9kID09PSAnJScgfHxcbiAgICAgICAgbW9kID09PSAnKycpIHtcbiAgICAgIHVzZXIgPSB1c2VyLnNsaWNlKDEpO1xuICAgIH1cbiAgICBjb25zdCBvdXQgPSBuZXcgVXNlcldpdGhNZXRhZGF0YSgpO1xuICAgIG91dC5uaWNrID0gdXNlcjtcbiAgICBpZiAobW9kID09PSAnficpIHtcbiAgICAgIG91dC5zdGF0dXMgPSBVc2VyU3RhdHVzZXMuRk9VTkRFUjtcbiAgICB9IGVsc2UgaWYgKG1vZCA9PT0gJyYnKSB7XG4gICAgICBvdXQuc3RhdHVzID0gVXNlclN0YXR1c2VzLk5FVF9PUEVSQVRPUjtcbiAgICB9IGVsc2UgaWYgKG1vZCA9PT0gJ0AnKSB7XG4gICAgICBvdXQuc3RhdHVzID0gVXNlclN0YXR1c2VzLk9QRVJBVE9SO1xuICAgIH0gZWxzZSBpZiAobW9kID09PSAnJScpIHtcbiAgICAgIG91dC5zdGF0dXMgPSBVc2VyU3RhdHVzZXMuSEFMRl9PUEVSQVRPUjtcbiAgICB9IGVsc2UgaWYgKG1vZCA9PT0gJysnKSB7XG4gICAgICBvdXQuc3RhdHVzID0gVXNlclN0YXR1c2VzLlZPSUNFO1xuICAgIH1cbiAgICByZXR1cm4gb3V0O1xuICB9XG5cbn1cblxuXG5leHBvcnQgY2xhc3MgVXNlcldpdGhNZXRhZGF0YSB7XG4gIHB1YmxpYyBuaWNrOiBzdHJpbmc7XG4gIHB1YmxpYyBzdGF0dXM6IFVzZXJTdGF0dXNlcztcbiAgcHVibGljIGlzTmV0T3A/OiBib29sZWFuO1xuICBwdWJsaWMgcmFuZG9tQj86IGJvb2xlYW47XG4gIHB1YmxpYyBhd2F5PzogYm9vbGVhbjtcbiAgcHVibGljIHNlcnZlckNvbm5lY3RlZD86IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIE1lc3NhZ2VXaXRoTWV0YWRhdGEge1xuICBwdWJsaWMgbWVzc2FnZTogc3RyaW5nO1xuICBwdWJsaWMgeW91dHViZT86IHN0cmluZztcbiAgcHVibGljIGltYWdlPzogc3RyaW5nO1xuICBwdWJsaWMgbGluaz86IHN0cmluZztcbiAgcHVibGljIHF1b3RlPzogUXVvdGVNZXNzYWdlO1xufVxuXG5leHBvcnQgY2xhc3MgUXVvdGVNZXNzYWdlIHtcbiAgcHVibGljIGF1dGhvcjogc3RyaW5nO1xuICBwdWJsaWMgb3JpZ2luYWxNZXNzYWdlOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBlbnVtIFVzZXJTdGF0dXNlcyB7XG4gIEZPVU5ERVIgPSAnRk9VTkRFUicsXG4gIE5FVF9PUEVSQVRPUiA9ICdORVRfT1BFUkFUT1InLFxuICBPUEVSQVRPUiA9ICdPUEVSQVRPUicsXG4gIEhBTEZfT1BFUkFUT1IgPSAnSEFMRl9PUEVSQVRPUicsXG4gIFZPSUNFID0gJ1ZPSUNFJyxcbiAgQkFOTkVEID0gJ0JBTk5FRCdcbn1cbiJdfQ==