import { Time } from './../utils/Time.util';
import { ModeHandler } from './../handlers/Mode.handler';
import { IndividualMessageTypes } from './../dto/IndividualMessage';
import { MessageHandler } from './../handlers/Message.handler';
import { UserInfoService } from './user-info.service';
import { ChannelListHandler } from './../handlers/ChannelList.handler';
import { UsersHandler } from './../handlers/Users.handler';
import { PartHandler } from './../handlers/Part.handler';
import { KickHandler } from './../handlers/Kick.handler';
import { JoinHandler } from './../handlers/Join.handler';
import { Injectable, EventEmitter } from '@angular/core';
import { Author, ChannelData } from './ChannelData';
import { StatusHandler } from '../handlers/Status.handler';
import { User } from '../dto/User';
import { ChannelStatusHandler } from '../handlers/ChannelStatus.handler';
import { UModes } from '../utils/UModes.utils';
import { PostProcessor } from '../utils/PostProcessor';
import { ModeratedHandler } from '../handlers/Moderated.handler';
import * as i0 from "@angular/core";
import * as i1 from "./user-info.service";
/**
 * Servicio para gestionar mis canales y los usuarios en esos canales
 */
export class ChannelsService {
    constructor(userSrv) {
        this.userSrv = userSrv;
        this.listChanged = new EventEmitter();
        this.messagesReceived = new EventEmitter();
        this.membersChanged = new EventEmitter();
        this.channels = [];
        // Subscribe to events
        JoinHandler.setHandler(this);
        KickHandler.setHandler(this);
        PartHandler.setHandler(this);
        UsersHandler.setHandler(this);
        ChannelListHandler.setHandler(this);
        StatusHandler.setHandlerNickChanged(this);
        ChannelStatusHandler.setHandler(this);
        MessageHandler.setHandler(this);
        ModeratedHandler.channelModerated.subscribe(d => {
            // canal moderado:
            const channel = d.partials[3][0] == '#' ? d.partials[3].substring(1) : d.partials[3];
            const channelObj = this.channels.find(chnl => chnl.name === channel);
            if (channelObj) {
                this.sendSpecialMSG(channelObj, d.body);
            }
        });
        ModeHandler.modeChange.subscribe((d) => {
            if (d.channelTarget != d.userTarget.nick) {
                const channel = d.channelTarget[0] == '#' ? d.channelTarget.substring(1) : d.channelTarget;
                const channelObj = this.channels.find(chnl => chnl.name === channel);
                if (channelObj) {
                    const user = channelObj.users.find(user => user.nick === d.userTarget.nick);
                    if (user) {
                        if (d.modeAdded) {
                            if (d.mode.indexOf('q') > -1) {
                                user.mode = UModes.FOUNDER;
                            }
                            else if (d.mode.indexOf('a') > -1 || d.mode.indexOf('A') > -1) {
                                user.mode = UModes.ADMIN;
                            }
                            else if (d.mode.indexOf('o') > -1 || d.mode.indexOf('O') > -1) {
                                user.mode = UModes.OPER;
                            }
                            else if (d.mode.indexOf('h') > -1 || d.mode.indexOf('H') > -1) {
                                user.mode = UModes.HALFOPER;
                            }
                            else if (d.mode.indexOf('v') > -1 || d.mode.indexOf('V') > -1) {
                                user.mode = UModes.VOICE;
                            }
                        }
                        else {
                            user.mode = undefined; // FIXME: acá habría que ver que modos le quedan.
                        }
                        this.membersChanged.emit({
                            channel,
                            users: channelObj.users
                        });
                    }
                    const action = d.modeAdded ? 'agregó' : 'quitó';
                    const mod = d.modeAdded ? '+' : '-';
                    this.sendSpecialMSG(channelObj, 'Se ' + action + ' el modo "' + mod + d.mode + '" a ' + d.userTarget.nick);
                }
            }
            else {
                // modo de canal
                const channel = d.channelTarget[0] == '#' ? d.channelTarget.substring(1) : d.channelTarget;
                const channelObj = this.channels.find(chnl => chnl.name === channel);
                if (channelObj) {
                    this.sendSpecialMSG(channelObj, 'Se cambió el modo del canal: ' + d.mode);
                }
            }
        });
        this.history = JSON.parse(localStorage.getItem('chan_history'));
        if (!this.history) {
            this.history = {};
        }
    }
    saveHistory(channel, msg) {
        if (!this.history[channel]) {
            this.history[channel] = [];
        }
        const msC = Object.assign({}, msg);
        msC.fromHistory = true;
        this.history[channel].push(msC);
        localStorage.setItem('chan_history', JSON.stringify(this.history));
    }
    getHistory(author) {
        return this.history[author];
    }
    onChannelList(user, channels) {
        // actualizamos nuestra lista de canales:
        if (user === this.userSrv.getNick()) {
            // agregamos nuevos canales
            const actualChnls = [];
            channels.forEach(channel => {
                const oldChnl = this.channels.find(chnl => chnl.name === channel.name);
                if (!oldChnl) {
                    this.addChannel(channel.name);
                }
                actualChnls.push(channel.name);
            });
            // buscamos elementos inexistentes
            this.channels.forEach((channel, idx) => {
                if (!actualChnls.find(chName => chName === channel.name)) {
                    this.channels.splice(idx, 1);
                }
            });
            this.listChanged.emit(this.channels);
        }
    }
    addChannel(channel) {
        const nChannel = new ChannelData();
        nChannel.name = channel;
        nChannel.topic = ChannelStatusHandler.getChannelTopic(nChannel.name);
        nChannel.messages = []; // Get from log?
        this.channels.push(nChannel);
        return nChannel;
    }
    onUserList(channel, users) {
        let channelObj = this.channels.find(chnl => chnl.name === channel);
        // si no existe este canal lo agregamos.
        if (!channelObj) {
            channelObj = this.addChannel(channel);
        }
        const actualUsers = [];
        users.forEach(currentUser => {
            const oldUser = channelObj.users.find(user => user.nick === currentUser.nick);
            if (!oldUser) {
                const newUser = new User(currentUser.nick);
                newUser.mode = currentUser.mode;
                channelObj.users.push(newUser);
            }
            else {
                oldUser.mode = currentUser.mode;
            }
            actualUsers.push(currentUser.nick);
        });
        // buscamos usuarios que ya no estan
        channelObj.users.forEach((user, idx) => {
            if (!actualUsers.find(acu => user.nick === acu)) {
                channelObj.users.splice(idx, 1);
            }
        });
        this.membersChanged.emit({ channel: channel, users: channelObj.users });
    }
    sendSpecialMSG(channel, message) {
        const msg = {
            message: message,
            date: Time.getTime() + ' ' + Time.getDateStr(),
            special: false,
            target: channel.name,
            notify: true
        };
        channel.messages.push(msg);
        this.messagesReceived.emit(msg);
    }
    onKick(data) {
        if (data.userTarget.nick === this.userSrv.getNick()) {
            this.channels.splice(this.channels.findIndex(chan => chan.name === data.channel.name));
            this.listChanged.emit(this.channels);
        }
        else {
            const chnlObj = this.channels.find(chnl => chnl.name === data.channel.name);
            if (chnlObj) {
                const idx = chnlObj.users.findIndex(user => user.nick === data.userTarget.nick);
                if (idx >= 0) {
                    chnlObj.users.splice(idx, 1);
                }
            }
            else {
                console.error('No se encontró el canal en el que se kickeó el usuario.', data.channel);
            }
            this.membersChanged.emit({ channel: data.channel.name, users: chnlObj.users });
            this.sendSpecialMSG(chnlObj, data.userTarget.nick + ' fué kickeado/a del canal por ' + data.operator + '.');
        }
    }
    onPart(data) {
        if (data.user.nick === this.userSrv.getNick()) {
            this.channels.splice(this.channels.findIndex(chan => chan.name === data.channel.name), 1);
            this.listChanged.emit(this.channels);
        }
        else {
            const chnlObj = this.channels.find(chnl => chnl.name === data.channel.name);
            if (chnlObj) {
                const idx = chnlObj.users.findIndex(user => user.nick === data.user.nick);
                if (idx >= 0) {
                    chnlObj.users.splice(idx, 1);
                }
            }
            else {
                console.error('No se encontró el canal en el que partió el usuario.', data.channel);
            }
            this.membersChanged.emit({ channel: data.channel.name, users: chnlObj.users });
            this.sendSpecialMSG(chnlObj, data.user.nick + ' se fué del canal');
        }
    }
    onJoin(data) {
        if (data.user.nick === this.userSrv.getNick()) {
            if (!this.channels.find(chnl => chnl.name === data.channel.name)) {
                this.addChannel(data.channel.name);
            }
            this.listChanged.emit(this.channels);
        }
        else {
            const chnlObj = this.channels.find(chnl => chnl.name === data.channel.name);
            if (chnlObj) {
                const newUser = new User(data.user.nick);
                newUser.mode = data.user.mode;
                chnlObj.users.push(newUser);
            }
            else {
                console.error('No se encontró el canal en el que se unió el usuario.', data.channel);
            }
            this.membersChanged.emit({ channel: data.channel.name, users: chnlObj.users });
            this.sendSpecialMSG(chnlObj, data.user.nick + ' se unió al canal');
        }
    }
    onNickChanged(nick) {
        // buscar en la lista de usuarios en cada canal el nick y cambiarlo
        this.channels.forEach((chnl) => {
            const oldUsr = chnl.users.find(usr => usr.nick === nick.oldNick);
            oldUsr.nick = nick.newNick;
            this.membersChanged.emit({ channel: chnl.name, users: chnl.users });
            this.sendSpecialMSG(chnl, nick.oldNick + ' se cambió el nick a ' + nick.newNick);
        });
    }
    onTopicUpdate(channel, newTopic) {
        if (channel[0] === '#') {
            channel = channel.substring(1);
        }
        const chnlObj = this.channels.find(chnl => chnl.name === channel);
        if (chnlObj) {
            chnlObj.topic = newTopic;
        }
        else {
            console.error('No se encontró el canal en el que se cambió el topic. ', channel);
        }
    }
    getChannels() {
        return this.channels;
    }
    getChannel(channel) {
        return this.channels.find(chanObj => chanObj.name == channel);
    }
    onMessageReceived(message) {
        if (message.messageType == IndividualMessageTypes.CHANMSG) {
            const tgtChan = message.channel[0] == '#' ? message.channel.substring(1) : message.channel;
            const chanObj = this.channels.find(chan => chan.name == tgtChan);
            const msg = {
                message: message.message,
                messageWithMetadata: PostProcessor.processMessage(message.message, message.author, this.userSrv.getNick()),
                author: new Author(message.author),
                date: message.date + ' ' + message.time,
                special: message.meAction,
                target: tgtChan
            };
            chanObj.messages.push(msg);
            this.messagesReceived.emit(msg);
            this.saveHistory(tgtChan, msg);
        }
    }
}
ChannelsService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ChannelsService_Factory() { return new ChannelsService(i0.ɵɵinject(i1.UserInfoService)); }, token: ChannelsService, providedIn: "root" });
ChannelsService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
ChannelsService.ctorParameters = () => [
    { type: UserInfoService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbm5lbHMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJDOi9Vc2Vycy9hbGV4YS9naXQvSVJDb3JlL3Byb2plY3RzL2lyY29yZS9zcmMvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvY2hhbm5lbHMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDNUMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ3pELE9BQU8sRUFBcUIsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN2RixPQUFPLEVBQUUsY0FBYyxFQUFxQixNQUFNLCtCQUErQixDQUFDO0FBQ2xGLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUV0RCxPQUFPLEVBQUUsa0JBQWtCLEVBQWlCLE1BQU0sbUNBQW1DLENBQUM7QUFDdEYsT0FBTyxFQUFjLFlBQVksRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsV0FBVyxFQUFVLE1BQU0sNEJBQTRCLENBQUM7QUFDakUsT0FBTyxFQUFFLFdBQVcsRUFBVSxNQUFNLDRCQUE0QixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pELE9BQU8sRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFrQixNQUFNLGVBQWUsQ0FBQztBQU9wRSxPQUFPLEVBQWlCLGFBQWEsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRTFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDbkMsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFFekUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQy9DLE9BQU8sRUFB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QUFDLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBRSxPQUFPLENBQUMsT0FBTyxDQUFDO1lBQzlGLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxPQUFPLENBQUMsQ0FBQztZQUNqRSxNQUFNLEdBQUcsR0FBbUI7Z0JBQzFCLE9BQU8sRUFBRyxPQUFPLENBQUMsT0FBa0I7Z0JBQ3BDLG1CQUFtQixFQUFHLGFBQWEsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLE9BQWlCLEVBQUUsT0FBTyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUNySCxNQUFNLEVBQUUsSUFBSSxNQUFNLENBQVMsT0FBTyxDQUFDLE1BQU0sQ0FBQztnQkFDMUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJLEdBQUcsR0FBRyxHQUFHLE9BQU8sQ0FBQyxJQUFJO2dCQUN2QyxPQUFPLEVBQUUsT0FBTyxDQUFDLFFBQVE7Z0JBQ3pCLE1BQU0sRUFBRSxPQUFPO2FBQ2hCLENBQUM7WUFDRixPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUMzQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2hDLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFBO1NBQy9CO0lBQ0gsQ0FBQzs7OztZQTNRRixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7OztZQTdCUSxlQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGltZSB9IGZyb20gJy4vLi4vdXRpbHMvVGltZS51dGlsJztcbmltcG9ydCB7IE1vZGVIYW5kbGVyIH0gZnJvbSAnLi8uLi9oYW5kbGVycy9Nb2RlLmhhbmRsZXInO1xuaW1wb3J0IHsgSW5kaXZpZHVhbE1lc3NhZ2UsIEluZGl2aWR1YWxNZXNzYWdlVHlwZXMgfSBmcm9tICcuLy4uL2R0by9JbmRpdmlkdWFsTWVzc2FnZSc7XG5pbXBvcnQgeyBNZXNzYWdlSGFuZGxlciwgT25NZXNzYWdlUmVjZWl2ZWQgfSBmcm9tICcuLy4uL2hhbmRsZXJzL01lc3NhZ2UuaGFuZGxlcic7XG5pbXBvcnQgeyBVc2VySW5mb1NlcnZpY2UgfSBmcm9tICcuL3VzZXItaW5mby5zZXJ2aWNlJztcbmltcG9ydCB7IE9uVG9waWNVcGRhdGUgfSBmcm9tICcuLy4uL2hhbmRsZXJzL0NoYW5uZWxTdGF0dXMuaGFuZGxlcic7XG5pbXBvcnQgeyBDaGFubmVsTGlzdEhhbmRsZXIsIE9uQ2hhbm5lbExpc3QgfSBmcm9tICcuLy4uL2hhbmRsZXJzL0NoYW5uZWxMaXN0LmhhbmRsZXInO1xuaW1wb3J0IHsgT25Vc2VyTGlzdCwgVXNlcnNIYW5kbGVyIH0gZnJvbSAnLi8uLi9oYW5kbGVycy9Vc2Vycy5oYW5kbGVyJztcbmltcG9ydCB7IFBhcnRIYW5kbGVyIH0gZnJvbSAnLi8uLi9oYW5kbGVycy9QYXJ0LmhhbmRsZXInO1xuaW1wb3J0IHsgS2lja0hhbmRsZXIsIE9uS2ljayB9IGZyb20gJy4vLi4vaGFuZGxlcnMvS2ljay5oYW5kbGVyJztcbmltcG9ydCB7IEpvaW5IYW5kbGVyLCBPbkpvaW4gfSBmcm9tICcuLy4uL2hhbmRsZXJzL0pvaW4uaGFuZGxlcic7XG5pbXBvcnQgeyBJbmplY3RhYmxlLCBFdmVudEVtaXR0ZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEF1dGhvciwgQ2hhbm5lbERhdGEsIEdlbmVyaWNNZXNzYWdlIH0gZnJvbSAnLi9DaGFubmVsRGF0YSc7XG5pbXBvcnQgeyBKb2luIH0gZnJvbSAnLi4vZHRvL0pvaW4nO1xuaW1wb3J0IHsgT25QYXJ0IH0gZnJvbSAnLi4vaGFuZGxlcnMvUGFydC5oYW5kbGVyJztcbmltcG9ydCB7IFBhcnQgfSBmcm9tICcuLi9kdG8vUGFydCc7XG5pbXBvcnQgeyBLaWNrSW5mbyB9IGZyb20gJy4uL2R0by9LaWNrSW5mbyc7XG5pbXBvcnQgeyBVc2VySW5DaGFubmVsIH0gZnJvbSAnLi4vZHRvL1VzZXJJbkNoYW5uZWwnO1xuaW1wb3J0IHsgQ2hhbm5lbCB9IGZyb20gJy4uL2R0by9DaGFubmVsJztcbmltcG9ydCB7IE9uTmlja0NoYW5nZWQsIFN0YXR1c0hhbmRsZXIgfSBmcm9tICcuLi9oYW5kbGVycy9TdGF0dXMuaGFuZGxlcic7XG5pbXBvcnQgeyBOaWNrQ2hhbmdlIH0gZnJvbSAnLi4vZHRvL05pY2tDaGFuZ2UnO1xuaW1wb3J0IHsgVXNlciB9IGZyb20gJy4uL2R0by9Vc2VyJztcbmltcG9ydCB7IENoYW5uZWxTdGF0dXNIYW5kbGVyIH0gZnJvbSAnLi4vaGFuZGxlcnMvQ2hhbm5lbFN0YXR1cy5oYW5kbGVyJztcbmltcG9ydCB7IE5ld01vZGUgfSBmcm9tICcuLi9kdG8vTmV3TW9kZSc7XG5pbXBvcnQgeyBVTW9kZXMgfSBmcm9tICcuLi91dGlscy9VTW9kZXMudXRpbHMnO1xuaW1wb3J0IHsgUG9zdFByb2Nlc3NvciB9IGZyb20gJy4uL3V0aWxzL1Bvc3RQcm9jZXNzb3InO1xuaW1wb3J0IHsgTW9kZXJhdGVkSGFuZGxlciB9IGZyb20gJy4uL2hhbmRsZXJzL01vZGVyYXRlZC5oYW5kbGVyJztcblxuLyoqXG4gKiBTZXJ2aWNpbyBwYXJhIGdlc3Rpb25hciBtaXMgY2FuYWxlcyB5IGxvcyB1c3VhcmlvcyBlbiBlc29zIGNhbmFsZXNcbiAqL1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgQ2hhbm5lbHNTZXJ2aWNlIGltcGxlbWVudHMgT25Kb2luLCBPblBhcnQsIE9uS2ljaywgT25Vc2VyTGlzdCwgT25DaGFubmVsTGlzdCwgT25OaWNrQ2hhbmdlZCwgT25Ub3BpY1VwZGF0ZSwgT25NZXNzYWdlUmVjZWl2ZWQge1xuXG4gIHB1YmxpYyByZWFkb25seSBsaXN0Q2hhbmdlZDogRXZlbnRFbWl0dGVyPENoYW5uZWxEYXRhW10+ID0gbmV3IEV2ZW50RW1pdHRlcjxDaGFubmVsRGF0YVtdPigpO1xuICBwdWJsaWMgcmVhZG9ubHkgbWVzc2FnZXNSZWNlaXZlZDogRXZlbnRFbWl0dGVyPEdlbmVyaWNNZXNzYWdlPiA9IG5ldyBFdmVudEVtaXR0ZXI8R2VuZXJpY01lc3NhZ2U+KCk7XG4gIHB1YmxpYyByZWFkb25seSBtZW1iZXJzQ2hhbmdlZDogRXZlbnRFbWl0dGVyPHtjaGFubmVsOiBzdHJpbmcsIHVzZXJzOiBVc2VyW119PiA9IG5ldyBFdmVudEVtaXR0ZXI8e2NoYW5uZWw6IHN0cmluZywgdXNlcnM6IFVzZXJbXX0+KCk7XG5cbiAgcHJpdmF0ZSBjaGFubmVsczogQ2hhbm5lbERhdGFbXSA9IFtdO1xuXG4gIHB1YmxpYyBoaXN0b3J5OiB7IFtrZXk6IHN0cmluZ106IEdlbmVyaWNNZXNzYWdlW10gfTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHVzZXJTcnY6IFVzZXJJbmZvU2VydmljZSkge1xuICAgIC8vIFN1YnNjcmliZSB0byBldmVudHNcbiAgICBKb2luSGFuZGxlci5zZXRIYW5kbGVyKHRoaXMpO1xuICAgIEtpY2tIYW5kbGVyLnNldEhhbmRsZXIodGhpcyk7XG4gICAgUGFydEhhbmRsZXIuc2V0SGFuZGxlcih0aGlzKTtcbiAgICBVc2Vyc0hhbmRsZXIuc2V0SGFuZGxlcih0aGlzKTtcbiAgICBDaGFubmVsTGlzdEhhbmRsZXIuc2V0SGFuZGxlcih0aGlzKTtcbiAgICBTdGF0dXNIYW5kbGVyLnNldEhhbmRsZXJOaWNrQ2hhbmdlZCh0aGlzKTtcbiAgICBDaGFubmVsU3RhdHVzSGFuZGxlci5zZXRIYW5kbGVyKHRoaXMpO1xuICAgIE1lc3NhZ2VIYW5kbGVyLnNldEhhbmRsZXIodGhpcyk7XG4gICAgTW9kZXJhdGVkSGFuZGxlci5jaGFubmVsTW9kZXJhdGVkLnN1YnNjcmliZShkID0+IHtcbiAgICAgIC8vIGNhbmFsIG1vZGVyYWRvOlxuICAgICAgY29uc3QgY2hhbm5lbCA9IGQucGFydGlhbHNbM11bMF0gPT0gJyMnID8gZC5wYXJ0aWFsc1szXS5zdWJzdHJpbmcoMSkgOiBkLnBhcnRpYWxzWzNdO1xuICAgICAgY29uc3QgY2hhbm5lbE9iaiA9IHRoaXMuY2hhbm5lbHMuZmluZChjaG5sID0+IGNobmwubmFtZSA9PT0gY2hhbm5lbCk7XG4gICAgICBpZihjaGFubmVsT2JqKSB7XG4gICAgICAgIHRoaXMuc2VuZFNwZWNpYWxNU0coY2hhbm5lbE9iaiwgZC5ib2R5KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBNb2RlSGFuZGxlci5tb2RlQ2hhbmdlLnN1YnNjcmliZSgoZDogTmV3TW9kZSkgPT4ge1xuICAgICAgaWYoZC5jaGFubmVsVGFyZ2V0ICE9IGQudXNlclRhcmdldC5uaWNrKSB7XG4gICAgICAgIGNvbnN0IGNoYW5uZWwgPSBkLmNoYW5uZWxUYXJnZXRbMF0gPT0gJyMnID8gZC5jaGFubmVsVGFyZ2V0LnN1YnN0cmluZygxKSA6IGQuY2hhbm5lbFRhcmdldDtcbiAgICAgICAgY29uc3QgY2hhbm5lbE9iaiA9IHRoaXMuY2hhbm5lbHMuZmluZChjaG5sID0+IGNobmwubmFtZSA9PT0gY2hhbm5lbCk7XG4gICAgICAgIGlmKGNoYW5uZWxPYmopIHtcbiAgICAgICAgICBjb25zdCB1c2VyID0gY2hhbm5lbE9iai51c2Vycy5maW5kKHVzZXIgPT4gdXNlci5uaWNrID09PSBkLnVzZXJUYXJnZXQubmljayk7XG4gICAgICAgICAgaWYodXNlcikge1xuICAgICAgICAgICAgaWYoZC5tb2RlQWRkZWQpIHtcbiAgICAgICAgICAgICAgaWYoZC5tb2RlLmluZGV4T2YoJ3EnKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgdXNlci5tb2RlID0gVU1vZGVzLkZPVU5ERVI7XG4gICAgICAgICAgICAgIH0gZWxzZSBpZihkLm1vZGUuaW5kZXhPZignYScpID4gLTEgfHwgZC5tb2RlLmluZGV4T2YoJ0EnKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgdXNlci5tb2RlID0gVU1vZGVzLkFETUlOO1xuICAgICAgICAgICAgICB9IGVsc2UgaWYoZC5tb2RlLmluZGV4T2YoJ28nKSA+IC0xIHx8IGQubW9kZS5pbmRleE9mKCdPJykgPiAtMSkge1xuICAgICAgICAgICAgICAgIHVzZXIubW9kZSA9IFVNb2Rlcy5PUEVSO1xuICAgICAgICAgICAgICB9IGVsc2UgaWYoZC5tb2RlLmluZGV4T2YoJ2gnKSA+IC0xIHx8IGQubW9kZS5pbmRleE9mKCdIJykgPiAtMSkge1xuICAgICAgICAgICAgICAgIHVzZXIubW9kZSA9IFVNb2Rlcy5IQUxGT1BFUjtcbiAgICAgICAgICAgICAgfSBlbHNlIGlmKGQubW9kZS5pbmRleE9mKCd2JykgPiAtMSB8fCBkLm1vZGUuaW5kZXhPZignVicpID4gLTEpIHtcbiAgICAgICAgICAgICAgICB1c2VyLm1vZGUgPSBVTW9kZXMuVk9JQ0U7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHVzZXIubW9kZSA9IHVuZGVmaW5lZDsgLy8gRklYTUU6IGFjw6EgaGFicsOtYSBxdWUgdmVyIHF1ZSBtb2RvcyBsZSBxdWVkYW4uXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLm1lbWJlcnNDaGFuZ2VkLmVtaXQoe1xuICAgICAgICAgICAgICBjaGFubmVsLFxuICAgICAgICAgICAgICB1c2VyczogY2hhbm5lbE9iai51c2Vyc1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY29uc3QgYWN0aW9uID0gZC5tb2RlQWRkZWQgPyAnYWdyZWfDsycgOiAncXVpdMOzJztcbiAgICAgICAgICBjb25zdCBtb2QgPSBkLm1vZGVBZGRlZCA/ICcrJyA6ICctJztcbiAgICAgICAgICB0aGlzLnNlbmRTcGVjaWFsTVNHKGNoYW5uZWxPYmosICdTZSAnICsgYWN0aW9uICsgJyBlbCBtb2RvIFwiJyArIG1vZCArIGQubW9kZSArICdcIiBhICcgKyBkLnVzZXJUYXJnZXQubmljayk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIG1vZG8gZGUgY2FuYWxcbiAgICAgICAgY29uc3QgY2hhbm5lbCA9IGQuY2hhbm5lbFRhcmdldFswXSA9PSAnIycgPyBkLmNoYW5uZWxUYXJnZXQuc3Vic3RyaW5nKDEpIDogZC5jaGFubmVsVGFyZ2V0O1xuICAgICAgICBjb25zdCBjaGFubmVsT2JqID0gdGhpcy5jaGFubmVscy5maW5kKGNobmwgPT4gY2hubC5uYW1lID09PSBjaGFubmVsKTtcbiAgICAgICAgaWYoY2hhbm5lbE9iaikge1xuICAgICAgICAgIHRoaXMuc2VuZFNwZWNpYWxNU0coY2hhbm5lbE9iaiwgJ1NlIGNhbWJpw7MgZWwgbW9kbyBkZWwgY2FuYWw6ICcgKyBkLm1vZGUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy5oaXN0b3J5ID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnY2hhbl9oaXN0b3J5JykpO1xuICAgIGlmKCF0aGlzLmhpc3RvcnkpIHtcbiAgICAgIHRoaXMuaGlzdG9yeSA9IHt9O1xuICAgIH1cbiAgfVxuXG4gIHNhdmVIaXN0b3J5KGNoYW5uZWw6IHN0cmluZywgbXNnOiBHZW5lcmljTWVzc2FnZSkge1xuICAgIGlmICghdGhpcy5oaXN0b3J5W2NoYW5uZWxdKSB7XG4gICAgICB0aGlzLmhpc3RvcnlbY2hhbm5lbF0gPSBbXTtcbiAgICB9XG4gICAgY29uc3QgbXNDID0gT2JqZWN0LmFzc2lnbih7fSwgbXNnKTtcbiAgICBtc0MuZnJvbUhpc3RvcnkgPSB0cnVlO1xuICAgIHRoaXMuaGlzdG9yeVtjaGFubmVsXS5wdXNoKG1zQyk7XG4gICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2NoYW5faGlzdG9yeScsIEpTT04uc3RyaW5naWZ5KHRoaXMuaGlzdG9yeSkpO1xuICB9XG5cbiAgZ2V0SGlzdG9yeShhdXRob3I6IHN0cmluZyk6IEdlbmVyaWNNZXNzYWdlW10ge1xuICAgIHJldHVybiB0aGlzLmhpc3RvcnlbYXV0aG9yXTtcbiAgfVxuXG4gIG9uQ2hhbm5lbExpc3QodXNlcjogc3RyaW5nLCBjaGFubmVsczogQ2hhbm5lbFtdKSB7XG4gICAgLy8gYWN0dWFsaXphbW9zIG51ZXN0cmEgbGlzdGEgZGUgY2FuYWxlczpcbiAgICBpZiAodXNlciA9PT0gdGhpcy51c2VyU3J2LmdldE5pY2soKSkge1xuICAgICAgLy8gYWdyZWdhbW9zIG51ZXZvcyBjYW5hbGVzXG4gICAgICBjb25zdCBhY3R1YWxDaG5scyA9IFtdO1xuICAgICAgY2hhbm5lbHMuZm9yRWFjaChjaGFubmVsID0+IHtcbiAgICAgICAgY29uc3Qgb2xkQ2hubCA9IHRoaXMuY2hhbm5lbHMuZmluZChjaG5sID0+IGNobmwubmFtZSA9PT0gY2hhbm5lbC5uYW1lKTtcbiAgICAgICAgaWYgKCFvbGRDaG5sKSB7XG4gICAgICAgICAgdGhpcy5hZGRDaGFubmVsKGNoYW5uZWwubmFtZSk7XG4gICAgICAgIH1cbiAgICAgICAgYWN0dWFsQ2hubHMucHVzaChjaGFubmVsLm5hbWUpO1xuICAgICAgfSk7XG4gICAgICAvLyBidXNjYW1vcyBlbGVtZW50b3MgaW5leGlzdGVudGVzXG4gICAgICB0aGlzLmNoYW5uZWxzLmZvckVhY2goKGNoYW5uZWwsIGlkeCkgPT4ge1xuICAgICAgICBpZiAoIWFjdHVhbENobmxzLmZpbmQoY2hOYW1lID0+IGNoTmFtZSA9PT0gY2hhbm5lbC5uYW1lKSkge1xuICAgICAgICAgIHRoaXMuY2hhbm5lbHMuc3BsaWNlKGlkeCwgMSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgdGhpcy5saXN0Q2hhbmdlZC5lbWl0KHRoaXMuY2hhbm5lbHMpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkQ2hhbm5lbChjaGFubmVsOiBzdHJpbmcpIHtcbiAgICBjb25zdCBuQ2hhbm5lbCA9IG5ldyBDaGFubmVsRGF0YSgpO1xuICAgIG5DaGFubmVsLm5hbWUgPSBjaGFubmVsO1xuICAgIG5DaGFubmVsLnRvcGljID0gQ2hhbm5lbFN0YXR1c0hhbmRsZXIuZ2V0Q2hhbm5lbFRvcGljKG5DaGFubmVsLm5hbWUpO1xuICAgIG5DaGFubmVsLm1lc3NhZ2VzID0gW107IC8vIEdldCBmcm9tIGxvZz9cbiAgICB0aGlzLmNoYW5uZWxzLnB1c2gobkNoYW5uZWwpO1xuICAgIHJldHVybiBuQ2hhbm5lbDtcbiAgfVxuXG4gIG9uVXNlckxpc3QoY2hhbm5lbDogc3RyaW5nLCB1c2VyczogVXNlckluQ2hhbm5lbFtdKSB7XG4gICAgbGV0IGNoYW5uZWxPYmogPSB0aGlzLmNoYW5uZWxzLmZpbmQoY2hubCA9PiBjaG5sLm5hbWUgPT09IGNoYW5uZWwpO1xuICAgIC8vIHNpIG5vIGV4aXN0ZSBlc3RlIGNhbmFsIGxvIGFncmVnYW1vcy5cbiAgICBpZiAoIWNoYW5uZWxPYmopIHtcbiAgICAgIGNoYW5uZWxPYmogPSB0aGlzLmFkZENoYW5uZWwoY2hhbm5lbCk7XG4gICAgfVxuICAgIGNvbnN0IGFjdHVhbFVzZXJzID0gW107XG4gICAgdXNlcnMuZm9yRWFjaChjdXJyZW50VXNlciA9PiB7XG4gICAgICBjb25zdCBvbGRVc2VyID0gY2hhbm5lbE9iai51c2Vycy5maW5kKHVzZXIgPT4gdXNlci5uaWNrID09PSBjdXJyZW50VXNlci5uaWNrKTtcbiAgICAgIGlmICghb2xkVXNlcikge1xuICAgICAgICBjb25zdCBuZXdVc2VyID0gbmV3IFVzZXIoY3VycmVudFVzZXIubmljayk7XG4gICAgICAgIG5ld1VzZXIubW9kZSA9IGN1cnJlbnRVc2VyLm1vZGU7XG4gICAgICAgIGNoYW5uZWxPYmoudXNlcnMucHVzaChuZXdVc2VyKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9sZFVzZXIubW9kZSA9IGN1cnJlbnRVc2VyLm1vZGU7XG4gICAgICB9XG4gICAgICBhY3R1YWxVc2Vycy5wdXNoKGN1cnJlbnRVc2VyLm5pY2spO1xuICAgIH0pO1xuICAgIC8vIGJ1c2NhbW9zIHVzdWFyaW9zIHF1ZSB5YSBubyBlc3RhblxuICAgIGNoYW5uZWxPYmoudXNlcnMuZm9yRWFjaCgodXNlciwgaWR4KSA9PiB7XG4gICAgICBpZiAoIWFjdHVhbFVzZXJzLmZpbmQoYWN1ID0+IHVzZXIubmljayA9PT0gYWN1KSkge1xuICAgICAgICBjaGFubmVsT2JqLnVzZXJzLnNwbGljZShpZHgsIDEpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHRoaXMubWVtYmVyc0NoYW5nZWQuZW1pdCh7Y2hhbm5lbDogY2hhbm5lbCwgdXNlcnM6IGNoYW5uZWxPYmoudXNlcnN9KTtcbiAgfVxuXG4gIHByaXZhdGUgc2VuZFNwZWNpYWxNU0coY2hhbm5lbDogQ2hhbm5lbERhdGEsIG1lc3NhZ2U6IHN0cmluZykge1xuICAgIGNvbnN0IG1zZzogR2VuZXJpY01lc3NhZ2UgPSB7XG4gICAgICBtZXNzYWdlOiBtZXNzYWdlLFxuICAgICAgZGF0ZTogVGltZS5nZXRUaW1lKCkgKyAnICcgKyBUaW1lLmdldERhdGVTdHIoKSxcbiAgICAgIHNwZWNpYWw6IGZhbHNlLFxuICAgICAgdGFyZ2V0OiBjaGFubmVsLm5hbWUsXG4gICAgICBub3RpZnk6IHRydWVcbiAgICB9O1xuICAgIGNoYW5uZWwubWVzc2FnZXMucHVzaChtc2cpO1xuICAgIHRoaXMubWVzc2FnZXNSZWNlaXZlZC5lbWl0KG1zZyk7XG4gIH1cblxuICBvbktpY2soZGF0YTogS2lja0luZm8pIHtcbiAgICBpZiAoZGF0YS51c2VyVGFyZ2V0Lm5pY2sgPT09IHRoaXMudXNlclNydi5nZXROaWNrKCkpIHtcbiAgICAgIHRoaXMuY2hhbm5lbHMuc3BsaWNlKHRoaXMuY2hhbm5lbHMuZmluZEluZGV4KGNoYW4gPT4gY2hhbi5uYW1lID09PSBkYXRhLmNoYW5uZWwubmFtZSkpO1xuICAgICAgdGhpcy5saXN0Q2hhbmdlZC5lbWl0KHRoaXMuY2hhbm5lbHMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBjaG5sT2JqID0gdGhpcy5jaGFubmVscy5maW5kKGNobmwgPT4gY2hubC5uYW1lID09PSBkYXRhLmNoYW5uZWwubmFtZSk7XG4gICAgICBpZiAoY2hubE9iaikge1xuICAgICAgICBjb25zdCBpZHggPSBjaG5sT2JqLnVzZXJzLmZpbmRJbmRleCh1c2VyID0+IHVzZXIubmljayA9PT0gZGF0YS51c2VyVGFyZ2V0Lm5pY2spO1xuICAgICAgICBpZiAoaWR4ID49IDApIHtcbiAgICAgICAgICBjaG5sT2JqLnVzZXJzLnNwbGljZShpZHgsIDEpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdObyBzZSBlbmNvbnRyw7MgZWwgY2FuYWwgZW4gZWwgcXVlIHNlIGtpY2tlw7MgZWwgdXN1YXJpby4nLCBkYXRhLmNoYW5uZWwpO1xuICAgICAgfVxuICAgICAgdGhpcy5tZW1iZXJzQ2hhbmdlZC5lbWl0KHtjaGFubmVsOiBkYXRhLmNoYW5uZWwubmFtZSwgdXNlcnM6IGNobmxPYmoudXNlcnN9KTtcbiAgICAgIHRoaXMuc2VuZFNwZWNpYWxNU0coY2hubE9iaiwgZGF0YS51c2VyVGFyZ2V0Lm5pY2sgKyAnIGZ1w6kga2lja2VhZG8vYSBkZWwgY2FuYWwgcG9yICcrIGRhdGEub3BlcmF0b3IgKycuJyk7XG4gICAgfVxuXG4gIH1cblxuICBvblBhcnQoZGF0YTogUGFydCkge1xuICAgIGlmIChkYXRhLnVzZXIubmljayA9PT0gdGhpcy51c2VyU3J2LmdldE5pY2soKSkge1xuICAgICAgdGhpcy5jaGFubmVscy5zcGxpY2UodGhpcy5jaGFubmVscy5maW5kSW5kZXgoY2hhbiA9PiBjaGFuLm5hbWUgPT09IGRhdGEuY2hhbm5lbC5uYW1lKSwgMSk7XG4gICAgICB0aGlzLmxpc3RDaGFuZ2VkLmVtaXQodGhpcy5jaGFubmVscyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGNobmxPYmogPSB0aGlzLmNoYW5uZWxzLmZpbmQoY2hubCA9PiBjaG5sLm5hbWUgPT09IGRhdGEuY2hhbm5lbC5uYW1lKTtcbiAgICAgIGlmIChjaG5sT2JqKSB7XG4gICAgICAgIGNvbnN0IGlkeCA9IGNobmxPYmoudXNlcnMuZmluZEluZGV4KHVzZXIgPT4gdXNlci5uaWNrID09PSBkYXRhLnVzZXIubmljayk7XG4gICAgICAgIGlmIChpZHggPj0gMCkge1xuICAgICAgICAgIGNobmxPYmoudXNlcnMuc3BsaWNlKGlkeCwgMSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ05vIHNlIGVuY29udHLDsyBlbCBjYW5hbCBlbiBlbCBxdWUgcGFydGnDsyBlbCB1c3VhcmlvLicsIGRhdGEuY2hhbm5lbCk7XG4gICAgICB9XG4gICAgICB0aGlzLm1lbWJlcnNDaGFuZ2VkLmVtaXQoe2NoYW5uZWw6IGRhdGEuY2hhbm5lbC5uYW1lLCB1c2VyczogY2hubE9iai51c2Vyc30pO1xuICAgICAgdGhpcy5zZW5kU3BlY2lhbE1TRyhjaG5sT2JqLCBkYXRhLnVzZXIubmljayArICcgc2UgZnXDqSBkZWwgY2FuYWwnKTtcbiAgICB9XG4gIH1cblxuICBvbkpvaW4oZGF0YTogSm9pbikge1xuICAgIGlmIChkYXRhLnVzZXIubmljayA9PT0gdGhpcy51c2VyU3J2LmdldE5pY2soKSkge1xuICAgICAgaWYgKCF0aGlzLmNoYW5uZWxzLmZpbmQoY2hubCA9PiBjaG5sLm5hbWUgPT09IGRhdGEuY2hhbm5lbC5uYW1lKSkge1xuICAgICAgICB0aGlzLmFkZENoYW5uZWwoZGF0YS5jaGFubmVsLm5hbWUpO1xuICAgICAgfVxuICAgICAgdGhpcy5saXN0Q2hhbmdlZC5lbWl0KHRoaXMuY2hhbm5lbHMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBjaG5sT2JqID0gdGhpcy5jaGFubmVscy5maW5kKGNobmwgPT4gY2hubC5uYW1lID09PSBkYXRhLmNoYW5uZWwubmFtZSk7XG4gICAgICBpZiAoY2hubE9iaikge1xuICAgICAgICBjb25zdCBuZXdVc2VyID0gbmV3IFVzZXIoZGF0YS51c2VyLm5pY2spO1xuICAgICAgICBuZXdVc2VyLm1vZGUgPSBkYXRhLnVzZXIubW9kZTtcbiAgICAgICAgY2hubE9iai51c2Vycy5wdXNoKG5ld1VzZXIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignTm8gc2UgZW5jb250csOzIGVsIGNhbmFsIGVuIGVsIHF1ZSBzZSB1bmnDsyBlbCB1c3VhcmlvLicsIGRhdGEuY2hhbm5lbCk7XG4gICAgICB9XG4gICAgICB0aGlzLm1lbWJlcnNDaGFuZ2VkLmVtaXQoe2NoYW5uZWw6IGRhdGEuY2hhbm5lbC5uYW1lLCB1c2VyczogY2hubE9iai51c2Vyc30pO1xuICAgICAgdGhpcy5zZW5kU3BlY2lhbE1TRyhjaG5sT2JqLCBkYXRhLnVzZXIubmljayArICcgc2UgdW5pw7MgYWwgY2FuYWwnKTtcbiAgICB9XG4gIH1cblxuICBvbk5pY2tDaGFuZ2VkKG5pY2s6IE5pY2tDaGFuZ2UpIHtcbiAgICAvLyBidXNjYXIgZW4gbGEgbGlzdGEgZGUgdXN1YXJpb3MgZW4gY2FkYSBjYW5hbCBlbCBuaWNrIHkgY2FtYmlhcmxvXG4gICAgdGhpcy5jaGFubmVscy5mb3JFYWNoKChjaG5sOiBDaGFubmVsRGF0YSkgPT4ge1xuICAgICAgY29uc3Qgb2xkVXNyID0gY2hubC51c2Vycy5maW5kKHVzciA9PiB1c3IubmljayA9PT0gbmljay5vbGROaWNrKTtcbiAgICAgIG9sZFVzci5uaWNrID0gbmljay5uZXdOaWNrO1xuICAgICAgdGhpcy5tZW1iZXJzQ2hhbmdlZC5lbWl0KHtjaGFubmVsOiBjaG5sLm5hbWUsIHVzZXJzOiBjaG5sLnVzZXJzfSk7XG4gICAgICB0aGlzLnNlbmRTcGVjaWFsTVNHKGNobmwsIG5pY2sub2xkTmljayArICcgc2UgY2FtYmnDsyBlbCBuaWNrIGEgJyArIG5pY2submV3Tmljayk7XG4gICAgfSk7XG4gIH1cblxuICBvblRvcGljVXBkYXRlKGNoYW5uZWw6IHN0cmluZywgbmV3VG9waWM6IHN0cmluZykge1xuICAgIGlmKGNoYW5uZWxbMF0gPT09ICcjJykge1xuICAgICAgY2hhbm5lbCA9IGNoYW5uZWwuc3Vic3RyaW5nKDEpO1xuICAgIH1cbiAgICBjb25zdCBjaG5sT2JqID0gdGhpcy5jaGFubmVscy5maW5kKGNobmwgPT4gY2hubC5uYW1lID09PSBjaGFubmVsKTtcbiAgICBpZiAoY2hubE9iaikge1xuICAgICAgY2hubE9iai50b3BpYyA9IG5ld1RvcGljO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdObyBzZSBlbmNvbnRyw7MgZWwgY2FuYWwgZW4gZWwgcXVlIHNlIGNhbWJpw7MgZWwgdG9waWMuICcsIGNoYW5uZWwpO1xuICAgIH1cbiAgfVxuXG4gIGdldENoYW5uZWxzKCkge1xuICAgIHJldHVybiB0aGlzLmNoYW5uZWxzO1xuICB9XG5cbiAgZ2V0Q2hhbm5lbChjaGFubmVsOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5jaGFubmVscy5maW5kKGNoYW5PYmogPT4gY2hhbk9iai5uYW1lID09IGNoYW5uZWwpO1xuICB9XG5cbiAgb25NZXNzYWdlUmVjZWl2ZWQobWVzc2FnZTogSW5kaXZpZHVhbE1lc3NhZ2UpIHtcbiAgICBpZihtZXNzYWdlLm1lc3NhZ2VUeXBlID09IEluZGl2aWR1YWxNZXNzYWdlVHlwZXMuQ0hBTk1TRykge1xuICAgICAgY29uc3QgdGd0Q2hhbiA9ICBtZXNzYWdlLmNoYW5uZWxbMF0gPT0gJyMnID8gIG1lc3NhZ2UuY2hhbm5lbC5zdWJzdHJpbmcoMSkgOiAgbWVzc2FnZS5jaGFubmVsO1xuICAgICAgY29uc3QgY2hhbk9iaiA9IHRoaXMuY2hhbm5lbHMuZmluZChjaGFuID0+IGNoYW4ubmFtZSA9PSB0Z3RDaGFuKTtcbiAgICAgIGNvbnN0IG1zZzogR2VuZXJpY01lc3NhZ2UgPSB7XG4gICAgICAgIG1lc3NhZ2U6IChtZXNzYWdlLm1lc3NhZ2UgYXMgc3RyaW5nKSxcbiAgICAgICAgbWVzc2FnZVdpdGhNZXRhZGF0YTogIFBvc3RQcm9jZXNzb3IucHJvY2Vzc01lc3NhZ2UobWVzc2FnZS5tZXNzYWdlIGFzIHN0cmluZywgbWVzc2FnZS5hdXRob3IsIHRoaXMudXNlclNydi5nZXROaWNrKCkpLFxuICAgICAgICBhdXRob3I6IG5ldyBBdXRob3I8c3RyaW5nPihtZXNzYWdlLmF1dGhvciksXG4gICAgICAgIGRhdGU6IG1lc3NhZ2UuZGF0ZSArICcgJyArIG1lc3NhZ2UudGltZSxcbiAgICAgICAgc3BlY2lhbDogbWVzc2FnZS5tZUFjdGlvbixcbiAgICAgICAgdGFyZ2V0OiB0Z3RDaGFuXG4gICAgICB9O1xuICAgICAgY2hhbk9iai5tZXNzYWdlcy5wdXNoKG1zZyk7XG4gICAgICB0aGlzLm1lc3NhZ2VzUmVjZWl2ZWQuZW1pdChtc2cpO1xuICAgICAgdGhpcy5zYXZlSGlzdG9yeSh0Z3RDaGFuLCBtc2cpXG4gICAgfVxuICB9XG59XG4iXX0=