import { WebSocketUtil } from './utils/WebSocket.util';
import { Injectable } from '@angular/core';
import { IRCParserV2 } from './IRCParserV2';
import { UserInfoService } from './services/user-info.service';
import { IndividualMessage, IndividualMessageTypes } from './dto/IndividualMessage';
import { Time } from './utils/Time.util';
import { MessageHandler } from './handlers/Message.handler';
import * as i0 from "@angular/core";
import * as i1 from "./services/user-info.service";
export class IRCoreService {
    constructor(userSrv) {
        this.userSrv = userSrv;
        WebSocketUtil.messageReceived.subscribe((message) => {
            if (message.message.indexOf('PING') === 0) {
                const pingResp = message.message.slice(5);
                this.sendRaw('PONG ' + pingResp);
                return;
            }
            if (message.message.indexOf('ERROR') === 0) {
                console.error('Received error from stream: ', message.message);
                return;
            }
            IRCParserV2.parseMessage(message.message).forEach(msg => {
                IRCParserV2.processMessage(msg, message.message, this.userSrv.getNick());
            });
        });
    }
    connect(url) {
        this.webSocket = new WebSocketUtil();
        this.webSocket.connect(url, 'WSocket');
    }
    handshake(username, apodo, gatwayHost) {
        this.sendRaw('ENCODING UTF-8');
        if (gatwayHost) {
            this.sendRaw('HOST ' + gatwayHost);
        }
        this.sendRaw('USER ' + username + ' * * :' + IRCoreService.clientName);
        this.setNick(apodo);
    }
    identify(password) {
        this.sendRaw('PRIVMSG NickServ identify ' + password);
    }
    serverPass(user, password) {
        this.sendRaw('PASS ' + user + ':' + password);
    }
    setNick(nick) {
        this.sendRaw('NICK ' + nick);
        this.userSrv.setNick(nick);
    }
    sendWhox(channel) {
        channel = channel[0] === '#' ? channel : '#' + channel;
        this.sendRaw('WHO ' + channel);
    }
    join(channel) {
        if (channel[0] != '#') {
            channel = '#' + channel;
        }
        this.sendRaw('JOIN ' + channel);
    }
    disconnect() {
        this.webSocket.disconnect();
    }
    sendRaw(rawMessage) {
        this.webSocket.send(rawMessage);
    }
    sendMessageOrCommand(command, target) {
        if (command[0] === '/') {
            let cmd = command.slice(1);
            const verb = cmd.split(' ')[0].toLowerCase();
            if (verb === 'query') {
                cmd = cmd.slice(5).trim();
                // TODO: query a cmd
            }
            if (verb === 'join') {
                // enviar cmd esto es un join
                this.sendRaw(cmd);
                return false;
            }
            if (verb === 'umode') {
                // enviar cmd esto es un join
                cmd = cmd.replace('umode', 'mode ' + this.userSrv.getNick());
            }
            if (verb === 'stop') {
                // enviar cmd esto es un join
                stopEff();
                return false;
            }
            if (verb === 'me') {
                cmd = cmd.slice(2).trim();
                this.sendRaw('PRIVMSG ' + target + ' :' + String.fromCharCode(1) + 'ACTION ' + cmd + String.fromCharCode(1));
                this._triggerMessage(cmd, target, true);
                return true;
            }
            if (verb === 'cs') {
                // chanserv?
                cmd = cmd.replace('cs', 'PRIVMSG ChanServ :');
            }
            if (verb === 'hc') {
                // chanserv?
                cmd = cmd.replace('hc', 'PRIVMSG HiraClient :');
            }
            if (verb === 'ns') {
                // nickserv?
                cmd = cmd.replace('ns', 'PRIVMSG NickServ :');
            }
            if (verb === 'msg') {
                cmd = cmd.replace('msg', 'PRIVMSG');
            }
            if (verb === 'leave') {
                cmd = cmd.replace('leave', 'PART');
            }
            if (verb === 'away') {
                if (cmd.length === 4) {
                    const now = new Date();
                    cmd += ' AFK desde ' + now.getDay() + '/' + (now.getMonth() + 1) + '/' + now.getFullYear() + ' ' +
                        now.getHours() + ':' + now.getMinutes();
                }
            }
            if (verb === 'back') {
                cmd = cmd.replace('back', 'away');
            }
            this.sendRaw(cmd);
            return false;
        }
        else {
            if (target) {
                this.sendRaw('PRIVMSG ' + target + ' :' + command);
                this._triggerMessage(command, target, false);
            }
            else {
                this.sendRaw(command);
            }
            return true;
        }
    }
    _triggerMessage(command, target, isMe) {
        const iMessage = new IndividualMessage();
        iMessage.author = this.userSrv.getNick();
        iMessage.message = command;
        iMessage.meAction = isMe;
        iMessage.date = Time.getDateStr();
        iMessage.time = Time.getTime();
        iMessage.messageType = target[0] == '#' ? IndividualMessageTypes.CHANMSG : IndividualMessageTypes.PRIVMSG;
        if (iMessage.messageType === IndividualMessageTypes.CHANMSG) {
            iMessage.channel = target;
        }
        else {
            iMessage.privateAuthor = iMessage.author;
            iMessage.author = target;
        }
        MessageHandler.onMessage(iMessage);
    }
    getWS() {
        return this.webSocket;
    }
}
IRCoreService.clientName = 'IRCoreV2';
IRCoreService.ɵprov = i0.ɵɵdefineInjectable({ factory: function IRCoreService_Factory() { return new IRCoreService(i0.ɵɵinject(i1.UserInfoService)); }, token: IRCoreService, providedIn: "root" });
IRCoreService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
IRCoreService.ctorParameters = () => [
    { type: UserInfoService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSVJDb3JlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiQzovVXNlcnMvYWxleGEvZ2l0L0lSQ29yZS9wcm9qZWN0cy9pcmNvcmUvc3JjLyIsInNvdXJjZXMiOlsibGliL0lSQ29yZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBZSxhQUFhLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNwRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDNUMsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQy9ELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3BGLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN6QyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sNEJBQTRCLENBQUM7OztBQU81RCxNQUFNLE9BQU8sYUFBYTtJQU14QixZQUFvQixPQUF3QjtRQUF4QixZQUFPLEdBQVAsT0FBTyxDQUFpQjtRQUMxQyxhQUFhLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE9BQW9CLEVBQUUsRUFBRTtZQUMvRCxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDekMsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxHQUFHLFFBQVEsQ0FBQyxDQUFDO2dCQUNqQyxPQUFPO2FBQ1I7WUFDRCxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDMUMsT0FBTyxDQUFDLEtBQUssQ0FBQyw4QkFBOEIsRUFB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QUFDLENBQUM7SUFDckMsQ0FBQztJQUVNLEtBQUs7UUFDVixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUM7SUFDeEIsQ0FBQzs7QUE1SmEsd0JBQVUsR0FBRyxVQUFVLENBQUM7OztZQUx2QyxVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7OztZQVRRLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNZXNzYWdlRGF0YSwgV2ViU29ja2V0VXRpbCB9IGZyb20gJy4vdXRpbHMvV2ViU29ja2V0LnV0aWwnO1xuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSVJDUGFyc2VyVjIgfSBmcm9tICcuL0lSQ1BhcnNlclYyJztcbmltcG9ydCB7IFVzZXJJbmZvU2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvdXNlci1pbmZvLnNlcnZpY2UnO1xuaW1wb3J0IHsgSW5kaXZpZHVhbE1lc3NhZ2UsIEluZGl2aWR1YWxNZXNzYWdlVHlwZXMgfSBmcm9tICcuL2R0by9JbmRpdmlkdWFsTWVzc2FnZSc7XG5pbXBvcnQgeyBUaW1lIH0gZnJvbSAnLi91dGlscy9UaW1lLnV0aWwnO1xuaW1wb3J0IHsgTWVzc2FnZUhhbmRsZXIgfSBmcm9tICcuL2hhbmRsZXJzL01lc3NhZ2UuaGFuZGxlcic7XG5cbmRlY2xhcmUgdmFyIHN0b3BFZmY7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIElSQ29yZVNlcnZpY2Uge1xuXG4gIHB1YmxpYyBzdGF0aWMgY2xpZW50TmFtZSA9ICdJUkNvcmVWMic7XG5cbiAgcHJpdmF0ZSB3ZWJTb2NrZXQ6IFdlYlNvY2tldFV0aWw7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSB1c2VyU3J2OiBVc2VySW5mb1NlcnZpY2UpIHtcbiAgICBXZWJTb2NrZXRVdGlsLm1lc3NhZ2VSZWNlaXZlZC5zdWJzY3JpYmUoKG1lc3NhZ2U6IE1lc3NhZ2VEYXRhKSA9PiB7XG4gICAgICBpZiAobWVzc2FnZS5tZXNzYWdlLmluZGV4T2YoJ1BJTkcnKSA9PT0gMCkge1xuICAgICAgICBjb25zdCBwaW5nUmVzcCA9IG1lc3NhZ2UubWVzc2FnZS5zbGljZSg1KTtcbiAgICAgICAgdGhpcy5zZW5kUmF3KCdQT05HICcgKyBwaW5nUmVzcCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmIChtZXNzYWdlLm1lc3NhZ2UuaW5kZXhPZignRVJST1InKSA9PT0gMCkge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdSZWNlaXZlZCBlcnJvciBmcm9tIHN0cmVhbTogJywgbWVzc2FnZS5tZXNzYWdlKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgSVJDUGFyc2VyVjIucGFyc2VNZXNzYWdlKG1lc3NhZ2UubWVzc2FnZSkuZm9yRWFjaChtc2cgPT4ge1xuICAgICAgICBJUkNQYXJzZXJWMi5wcm9jZXNzTWVzc2FnZShtc2csIG1lc3NhZ2UubWVzc2FnZSwgdGhpcy51c2VyU3J2LmdldE5pY2soKSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBjb25uZWN0KHVybDogc3RyaW5nKSB7XG4gICAgdGhpcy53ZWJTb2NrZXQgPSBuZXcgV2ViU29ja2V0VXRpbCgpO1xuICAgIHRoaXMud2ViU29ja2V0LmNvbm5lY3QodXJsLCAnV1NvY2tldCcpO1xuICB9XG5cbiAgcHVibGljIGhhbmRzaGFrZSh1c2VybmFtZTogc3RyaW5nLCBhcG9kbzogc3RyaW5nLCBnYXR3YXlIb3N0Pzogc3RyaW5nKSB7XG4gICAgdGhpcy5zZW5kUmF3KCdFTkNPRElORyBVVEYtOCcpO1xuICAgIGlmIChnYXR3YXlIb3N0KSB7XG4gICAgICB0aGlzLnNlbmRSYXcoJ0hPU1QgJyArIGdhdHdheUhvc3QpO1xuICAgIH1cbiAgICB0aGlzLnNlbmRSYXcoJ1VTRVIgJyArIHVzZXJuYW1lICsgJyAqICogOicgKyBJUkNvcmVTZXJ2aWNlLmNsaWVudE5hbWUpO1xuICAgIHRoaXMuc2V0TmljayhhcG9kbyk7XG4gIH1cblxuICBwdWJsaWMgaWRlbnRpZnkocGFzc3dvcmQ6IHN0cmluZykge1xuICAgIHRoaXMuc2VuZFJhdygnUFJJVk1TRyBOaWNrU2VydiBpZGVudGlmeSAnICsgcGFzc3dvcmQpO1xuICB9XG5cbiAgcHVibGljIHNlcnZlclBhc3ModXNlcjogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nKSB7XG4gICAgdGhpcy5zZW5kUmF3KCdQQVNTICcgKyB1c2VyICsgJzonICsgcGFzc3dvcmQpO1xuICB9XG5cbiAgcHVibGljIHNldE5pY2sobmljazogc3RyaW5nKSB7XG4gICAgdGhpcy5zZW5kUmF3KCdOSUNLICcgKyBuaWNrKTtcbiAgICB0aGlzLnVzZXJTcnYuc2V0TmljayhuaWNrKTtcbiAgfVxuXG4gIHB1YmxpYyBzZW5kV2hveChjaGFubmVsKSB7XG4gICAgY2hhbm5lbCA9IGNoYW5uZWxbMF0gPT09ICcjJyA/IGNoYW5uZWwgOiAnIycgKyBjaGFubmVsO1xuICAgIHRoaXMuc2VuZFJhdygnV0hPICcgKyBjaGFubmVsKTtcbiAgfVxuXG4gIHB1YmxpYyBqb2luKGNoYW5uZWw6IHN0cmluZykge1xuICAgIGlmKGNoYW5uZWxbMF0gIT0gJyMnKSB7XG4gICAgICBjaGFubmVsID0gJyMnICsgY2hhbm5lbDtcbiAgICB9XG4gICAgdGhpcy5zZW5kUmF3KCdKT0lOICcgKyBjaGFubmVsKVxuICB9XG5cbiAgcHVibGljIGRpc2Nvbm5lY3QoKTogdm9pZCB7XG4gICAgdGhpcy53ZWJTb2NrZXQuZGlzY29ubmVjdCgpO1xuICB9XG5cbiAgcHVibGljIHNlbmRSYXcocmF3TWVzc2FnZTogc3RyaW5nKSB7XG4gICAgdGhpcy53ZWJTb2NrZXQuc2VuZChyYXdNZXNzYWdlKTtcbiAgfVxuXG4gIHB1YmxpYyBzZW5kTWVzc2FnZU9yQ29tbWFuZChjb21tYW5kOiBzdHJpbmcsIHRhcmdldD86IHN0cmluZyk6IGJvb2xlYW4geyAvLyByZXR1cm4gdHJ1ZSBpZiBpcyBtZXNzYWdlIG9yIGZhbHNlIGlmIGlzIGNvbW1hbmQuXG4gICAgaWYgKGNvbW1hbmRbMF0gPT09ICcvJykge1xuICAgICAgbGV0IGNtZCA9IGNvbW1hbmQuc2xpY2UoMSk7XG4gICAgICBjb25zdCB2ZXJiID0gY21kLnNwbGl0KCcgJylbMF0udG9Mb3dlckNhc2UoKTtcbiAgICAgIGlmICh2ZXJiID09PSAncXVlcnknKSB7XG4gICAgICAgIGNtZCA9IGNtZC5zbGljZSg1KS50cmltKCk7XG4gICAgICAgIC8vIFRPRE86IHF1ZXJ5IGEgY21kXG4gICAgICB9XG4gICAgICBpZiAodmVyYiA9PT0gJ2pvaW4nKSB7XG4gICAgICAgIC8vIGVudmlhciBjbWQgZXN0byBlcyB1biBqb2luXG4gICAgICAgIHRoaXMuc2VuZFJhdyhjbWQpO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICBpZiAodmVyYiA9PT0gJ3Vtb2RlJykge1xuICAgICAgICAvLyBlbnZpYXIgY21kIGVzdG8gZXMgdW4gam9pblxuICAgICAgICBjbWQgPSBjbWQucmVwbGFjZSgndW1vZGUnLCAnbW9kZSAnICsgdGhpcy51c2VyU3J2LmdldE5pY2soKSk7XG4gICAgICB9XG4gICAgICBpZiAodmVyYiA9PT0gJ3N0b3AnKSB7XG4gICAgICAgIC8vIGVudmlhciBjbWQgZXN0byBlcyB1biBqb2luXG4gICAgICAgIHN0b3BFZmYoKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgaWYgKHZlcmIgPT09ICdtZScpIHtcbiAgICAgICAgY21kID0gY21kLnNsaWNlKDIpLnRyaW0oKTtcbiAgICAgICAgdGhpcy5zZW5kUmF3KCdQUklWTVNHICcgKyB0YXJnZXQgKyAnIDonICsgU3RyaW5nLmZyb21DaGFyQ29kZSgxKSArICdBQ1RJT04gJyArIGNtZCArIFN0cmluZy5mcm9tQ2hhckNvZGUoMSkpO1xuICAgICAgICB0aGlzLl90cmlnZ2VyTWVzc2FnZShjbWQsIHRhcmdldCwgdHJ1ZSk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgICAgaWYgKHZlcmIgPT09ICdjcycpIHtcbiAgICAgICAgLy8gY2hhbnNlcnY/XG4gICAgICAgIGNtZCA9IGNtZC5yZXBsYWNlKCdjcycsICdQUklWTVNHIENoYW5TZXJ2IDonKTtcbiAgICAgIH1cbiAgICAgIGlmICh2ZXJiID09PSAnaGMnKSB7XG4gICAgICAgIC8vIGNoYW5zZXJ2P1xuICAgICAgICBjbWQgPSBjbWQucmVwbGFjZSgnaGMnLCAnUFJJVk1TRyBIaXJhQ2xpZW50IDonKTtcbiAgICAgIH1cbiAgICAgIGlmICh2ZXJiID09PSAnbnMnKSB7XG4gICAgICAgIC8vIG5pY2tzZXJ2P1xuICAgICAgICBjbWQgPSBjbWQucmVwbGFjZSgnbnMnLCAnUFJJVk1TRyBOaWNrU2VydiA6Jyk7XG4gICAgICB9XG4gICAgICBpZiAodmVyYiA9PT0gJ21zZycpIHtcbiAgICAgICAgY21kID0gY21kLnJlcGxhY2UoJ21zZycsICdQUklWTVNHJyk7XG4gICAgICB9XG4gICAgICBpZiAodmVyYiA9PT0gJ2xlYXZlJykge1xuICAgICAgICBjbWQgPSBjbWQucmVwbGFjZSgnbGVhdmUnLCAnUEFSVCcpO1xuICAgICAgfVxuICAgICAgaWYgKHZlcmIgPT09ICdhd2F5Jykge1xuICAgICAgICBpZiAoY21kLmxlbmd0aCA9PT0gNCkge1xuICAgICAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgY21kICs9ICcgQUZLIGRlc2RlICcgKyBub3cuZ2V0RGF5KCkgKyAnLycgKyAobm93LmdldE1vbnRoKCkgKyAxKSArICcvJyArIG5vdy5nZXRGdWxsWWVhcigpICsgJyAnICtcbiAgICAgICAgICAgICAgICAgIG5vdy5nZXRIb3VycygpICsgJzonICsgbm93LmdldE1pbnV0ZXMoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKHZlcmIgPT09ICdiYWNrJykge1xuICAgICAgICBjbWQgPSBjbWQucmVwbGFjZSgnYmFjaycsICdhd2F5Jyk7XG4gICAgICB9XG4gICAgICB0aGlzLnNlbmRSYXcoY21kKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYodGFyZ2V0KSB7XG4gICAgICAgIHRoaXMuc2VuZFJhdygnUFJJVk1TRyAnICsgdGFyZ2V0ICsgJyA6JyArIGNvbW1hbmQpO1xuICAgICAgICB0aGlzLl90cmlnZ2VyTWVzc2FnZShjb21tYW5kLCB0YXJnZXQsIGZhbHNlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuc2VuZFJhdyhjb21tYW5kKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX3RyaWdnZXJNZXNzYWdlKGNvbW1hbmQ6IHN0cmluZywgdGFyZ2V0OiBzdHJpbmcsIGlzTWU6IGJvb2xlYW4pIHtcbiAgICBjb25zdCBpTWVzc2FnZSA9IG5ldyBJbmRpdmlkdWFsTWVzc2FnZSgpO1xuICAgIGlNZXNzYWdlLmF1dGhvciA9IHRoaXMudXNlclNydi5nZXROaWNrKCk7XG4gICAgaU1lc3NhZ2UubWVzc2FnZSA9IGNvbW1hbmQ7XG4gICAgaU1lc3NhZ2UubWVBY3Rpb24gPSBpc01lO1xuICAgIGlNZXNzYWdlLmRhdGUgPSBUaW1lLmdldERhdGVTdHIoKTtcbiAgICBpTWVzc2FnZS50aW1lID0gVGltZS5nZXRUaW1lKCk7XG4gICAgaU1lc3NhZ2UubWVzc2FnZVR5cGUgPSB0YXJnZXRbMF0gPT0gJyMnID8gSW5kaXZpZHVhbE1lc3NhZ2VUeXBlcy5DSEFOTVNHIDogSW5kaXZpZHVhbE1lc3NhZ2VUeXBlcy5QUklWTVNHO1xuICAgIGlmKGlNZXNzYWdlLm1lc3NhZ2VUeXBlID09PSBJbmRpdmlkdWFsTWVzc2FnZVR5cGVzLkNIQU5NU0cpIHtcbiAgICAgIGlNZXNzYWdlLmNoYW5uZWwgPSB0YXJnZXQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlNZXNzYWdlLnByaXZhdGVBdXRob3IgPSBpTWVzc2FnZS5hdXRob3I7XG4gICAgICBpTWVzc2FnZS5hdXRob3IgPSB0YXJnZXQ7XG4gICAgfVxuICAgIE1lc3NhZ2VIYW5kbGVyLm9uTWVzc2FnZShpTWVzc2FnZSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0V1MoKTogV2ViU29ja2V0VXRpbHtcbiAgICByZXR1cm4gdGhpcy53ZWJTb2NrZXQ7XG4gIH1cbn1cbiJdfQ==